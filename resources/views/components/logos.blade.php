
@props(['initialDelta' => null])

@push('head-script')
<link rel="stylesheet" href="{{ asset('css/logos.css') }}">
<script src="{{ asset('js/logos.js') }}"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" defer></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
<style>
  #sidebar-controls {
      display: none;
      position: absolute;
      z-index: 5;
      
  }
  #sidebar-controls button {
      background-color: transparent;
      border: none;
      padding: 0;
  }
  #sidebar-controls .h-icon {
      background-color: #444e;
      color: #ccc;
      border-radius: 50%;
      padding: 7px;
      width: 20px;
      height: 20px;
      box-sizing: content-box;
  }
  #sidebar-controls .h-icon:hover {
      color: #fff;
  }
  #sidebar-controls .controls {
    display: none; 
    margin-left: 5px;
  }
  #sidebar-controls .controls button {
    margin-left: 13px;
  }

  #sidebar-controls #show-controls .h-icon {
    transition: all 50ms;
    transform-origin: center;
    color: #4449;
    background-color: transparent;
  }
  
  #sidebar-controls.active #show-controls .h-icon {
      margin: auto 0;
      background-color: #444e;
      color:#ccc;
      transform: rotate(45deg);
  }

  #sidebar-controls #show-controls .h-icon:hover {
    color:white;
    background-color: #444e;
  }

  #sidebar-controls.active .controls {
    display: inline-block;
  }


  #sidebar-controls.active #show-controls .h-icon:hover {
    color:white;
  }

  #sidebar-controls button {
      cursor: pointer;
      display: inline-block;
      height: 20px;
      width: 20px;
      text-align: center;
  }
  #sidebar-controls button:active, #sidebar-controls button:focus {
      outline: none;  
  }

  #toolbar .ql-formats .lg-btn {
    color:#fffa;
  }
  #toolbar .ql-formats .lg-btn:hover {
    color:#ffff;
  }
  #toolbar .ql-formats .lg-btn:focus {
    outline: none;
  }

</style>

@endpush

@push('foot-script')

<script>

  let initialDelta = @json($initialDelta);

  let Block = Quill.import('blots/block');


  let sideControls = document.querySelector('#sidebar-controls');
  let quillContainer = document.querySelector('#quill-container');
  let btnShowSideControls = document.querySelector('#show-controls');



  btnShowSideControls.addEventListener('click', function() {
    sideControls.classList.toggle('active')
    quill.focus();
  })
  
  let quill = new Quill(quillContainer,{
      modules: {
          toolbar: '#toolbar',
          citations: {
            type: SourceTypes.CITATION_VANCOUVER,
            class: 'citation',
            handlers: {
                create: function (node, data, controller) {
                    node.setAttribute('title', data.key)
                }
            }}
        },
      theme:'bubble',
      // debug:'info',
      placeholder: "Escribe algo Ã©pico..."
  });

  if(initialDelta) {
    quill.setContents(initialDelta, 'api')
  }

  const Citations = quill.getModule('citations');
  quill.addContainer(sideControls);

  const quillInputEvent = new CustomEvent('quill-input', {
    bubbles: true,
    detail: {
      delta: () => quill.getContents(),
      html: () => quill.scroll.domNode.innerHTML
    }
  })



  quill.on('editor-change', function(eventType, ...args) {
    if (eventType === 'text-change') {
        const [delta, oldDelta, source] = args;
        // console.log("Event '%s'\nrange:%o\noldRange:%o\nsource:%s", 
        //     eventType, delta, oldDelta, source)
        if (source == 'user') {
            delta.forEach((op) => {
                if (op.insert == "\n") {
                    // Evaluates in next 'tick', after quill updates.
                    new Promise( (resolve, reject) => {
                        resolve();
                    }).then(corregirOffset);
                }
            });
          quillContainer.dispatchEvent(quillInputEvent)

        }

    } else if (eventType === 'selection-change') {
        const [range, oldRange, source] = args;
        if(range == null) return;
        if(range.length === 0) {
          // console.log("Event '%s'\nrange:%o\noldRange:%o\nsource:%s", 
          //   eventType, range, oldRange, source);
          const [block, offset] = quill.scroll.descendant(Block, range.index);
          if(block != null && block.domNode.firstChild instanceof HTMLBRElement) {
            // console.log("Descendientes:\nblock: %o\noffset: %i",block, offset);
            let lineBounds = quill.getBounds(range);
            sideControls.style.display = 'block'
            sideControls.style.left = lineBounds.left - 42 + "px"
            // console.log(lineBounds)
            sideControls.style.top = lineBounds.top - 7  + "px"
          } else {
            // console.log('escondiendo');
            sideControls.style.display = 'none';
            sideControls.classList.remove('active')
          }
        } else {
          sideControls.style.display = 'none';
          sideControls.classList.remove('active')
        }
        // console.log("Event '%s'\nrange:%o\noldRange:%o\nsource:%s", 
        //     eventType, range, oldRange, source)

    }
  })

  function corregirOffset() {
    // console.log('corrigiendo offset');
    let bounds = quill.getBounds(quill.getSelection().index);
    let margin = bounds.height * 5; // px
    // console.log(bounds);
    let screenBottom = window.pageYOffset + window.innerHeight;
    let cursorBottom =  bounds.bottom + quillContainer.offsetTop
    // console.log('screen bottom: ' + screenBottom + ': cursorBottom: ' + cursorBottom);
    if (cursorBottom + margin > screenBottom ) {
      window.scrollTo(0, cursorBottom + margin * 3 - window.innerHeight)
    }
  }

  const videoButton = document.querySelector('#video-button');
  videoButton.addEventListener('click', () => console.log('insertar video'));

  // const quillWrapp = document.querySelector('#quill-wrapp')
  // quillWrapp.addEventListener('quill-input', (e) => console.log( e.detail.contenido() ) )
</script>
@endpush
<div wire:ignore>

  <div id="toolbar">
    <span class="ql-formats">
        <select class="ql-header">
            <option value="2"></option>
            <option value="3"></option>
            <option selected></option>
        </select>
    </span>
    <span class="ql-formats">
      <button class="ql-bold"></button>
      <button class="ql-italic"></button>
      <button class="ql-list" value="ordered"></button>
      <button class="ql-list" value="bullet"></button>
      <button class="ql-script" value="sub"></button>
      <button class="ql-script" value="super"></button>
      <button class="ql-formula"></button>
      <button class="ql-blockquote"></button>
      <button id="add-source" class="lg-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z" />
        </svg>
      </button>
      <button id="add-note" class="lg-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd" />
        </svg>
      </button>
      <button class="ql-link"></button>
    </span>
  </div>
  
  <div id="sidebar-controls">
    <button id="show-controls" type="button">
      <svg class="h-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
      </svg>
    </button>
    <span class="controls">
      <button id="image-button" type="button">
        <svg class="h-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A2 2 0 0011.172 3H8.828a2 2 0 00-1.414.586L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" />
        </svg>
      </button>
      <button id="video-button" type="button">      
        <svg class="h-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
        </svg>
      </button>
      <button id="tweet-button" type="button">      
        <svg viewBox="0 0 24 24" class="h-icon" fill="currentColor">
          <g><path d="M23.643 4.937c-.835.37-1.732.62-2.675.733.962-.576 1.7-1.49 2.048-2.578-.9.534-1.897.922-2.958 1.13-.85-.904-2.06-1.47-3.4-1.47-2.572 0-4.658 2.086-4.658 4.66 0 .364.042.718.12 1.06-3.873-.195-7.304-2.05-9.602-4.868-.4.69-.63 1.49-.63 2.342 0 1.616.823 3.043 2.072 3.878-.764-.025-1.482-.234-2.11-.583v.06c0 2.257 1.605 4.14 3.737 4.568-.392.106-.803.162-1.227.162-.3 0-.593-.028-.877-.082.593 1.85 2.313 3.198 4.352 3.234-1.595 1.25-3.604 1.995-5.786 1.995-.376 0-.747-.022-1.112-.065 2.062 1.323 4.51 2.093 7.14 2.093 8.57 0 13.255-7.098 13.255-13.254 0-.2-.005-.402-.014-.602.91-.658 1.7-1.477 2.323-2.41z"></path></g>
        </svg>  
      </button>
      <button id="divider-button" type="button">
        <svg class="h-icon" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z" />
        </svg>
      </button>
    </span>
  </div>
  
  <div {{ $attributes }} id="quill-wrapp" >
      <div id="quill-container">
  {{--  test text
                  <h1 class="ql-align-center">CapÃ­tulo IV. Donde se prosigue la narraciÃ³n de la desgracia de nuestro caballero</h1><p class="ql-align-justify">	Viendo, pues, que, en efeto, no podÃ­a menearse, acordÃ³ de acogerse a su ordinario remedio, que era pensar en algÃºn paso de sus libros; y trÃºjole su locura a la memoria aquel de Valdovinos y del marquÃ©s de Mantua, cuando Carloto le dejÃ³ herido en la montiÃ±a, historia sabida de los niÃ±os, no ignorada de los mozos, celebrada y aun creÃ­da de los viejos; y, con todo esto, no mÃ¡s verdadera que los milagros de Mahoma. Ãsta, pues, le pareciÃ³ a Ã©l que le venÃ­a de molde para el paso en que se hallaba; y asÃ­, con muestras de grande sentimiento, se comenzÃ³ a volcar por la tierra y a decir con debilitado aliento lo mesmo que dicen decÃ­a el herido caballero del bosque:</p><p class="ql-align-justify">	<em>-Â¿Donde estÃ¡s, seÃ±ora mÃ­a,</em></p><p class="ql-align-justify"><em>que no te duele mi mal?</em></p><p class="ql-align-justify"><em>O no lo sabes, seÃ±ora,</em></p><p class="ql-align-justify"><em>o eres falsa y desleal.</em></p><p class="ql-align-justify">	Y, desta manera, fue prosiguiendo el romance hasta aquellos versos que dicen:</p><p class="ql-align-justify">	<em>-Â¡Oh noble marquÃ©s de Mantua,</em></p><p class="ql-align-justify"><em>mi tÃ­o y seÃ±or carnal!</em></p><p class="ql-align-justify">	Y quiso la suerte que, cuando llegÃ³ a este verso, acertÃ³ a pasar por allÃ­ un labrador de su mesmo lugar y vecino suyo, que venÃ­a de llevar una carga de trigo al molino; el cual, viendo aquel hombre allÃ­ tendido, se llegÃ³ a Ã©l y le preguntÃ³ que quiÃ©n era y quÃ© mal sentÃ­a que tan tristemente se quejaba. Don Quijote creyÃ³, sin duda, que aquÃ©l era el marquÃ©s de Mantua, su tÃ­o; y asÃ­, no le respondiÃ³ otra cosa si no fue proseguir en su romance, donde le daba cuenta de su desgracia y de los amores del hijo del Emperante con su esposa, todo de la mesma manera que el romance lo canta.</p><p class="ql-align-justify">	El labrador estaba admirado oyendo aquellos disparates; y, quitÃ¡ndole la visera, que ya estaba hecha pedazos de los palos, le limpiÃ³ el rostro, que le tenÃ­a cubierto de polvo; y apenas le hubo limpiado, cuando le conociÃ³ y le dijo:</p><p class="ql-align-justify">	â SeÃ±or Quijana âque asÃ­ se debÃ­a de llamar cuando Ã©l tenÃ­a juicio y no habÃ­a pasado de hidalgo sosegado a caballero andanteâ, Â¿quiÃ©n ha puesto a vuestra merced desta suerte?</p><p class="ql-align-justify">	Pero Ã©l seguÃ­a con su romance a cuanto le preguntaba. Viendo esto el buen hombre, lo mejor que pudo le quitÃ³ el peto y espaldar, para ver si tenÃ­a alguna herida; pero no vio sangre ni seÃ±al alguna. ProcurÃ³ levantarle del suelo, y no con poco trabajo le subiÃ³ sobre su jumento, por parecer caballerÃ­a mÃ¡s sosegada. RecogiÃ³ las armas, hasta las astillas de la lanza, y liÃ³las sobre Rocinante, al cual tomÃ³ de la rienda, y del cabestro al asno, y se encaminÃ³ hacia su pueblo, bien pensativo de oÃ­r los disparates que don Quijote decÃ­a; y no menos iba don Quijote, que, de puro molido y quebrantado, no se podÃ­a tener sobre el borrico, y de cuando en cuando daba unos suspiros que los ponÃ­a en el cielo; de modo que de nuevo obligÃ³ a que el labrador le preguntase le dijese quÃ© mal sentÃ­a; y no parece sino que el diablo le traÃ­a a la memoria los cuentos acomodados a sus sucesos, porque, en aquel punto, olvidÃ¡ndose de Valdovinos, se acordÃ³ del moro AbindarrÃ¡ez, cuando el alcaide de Antequera, Rodrigo de NarvÃ¡ez, le prendiÃ³ y llevÃ³ cautivo a su alcaidÃ­a. De suerte que, cuando el labrador le volviÃ³ a preguntar que cÃ³mo estaba y quÃ© sentÃ­a, le respondiÃ³ las mesmas palabras y razones que el cautivo Abencerraje respondÃ­a a Rodrigo de NarvÃ¡ez, del mesmo modo que Ã©l habÃ­a leÃ­do la historia en La Diana, de Jorge de Montemayor, donde se escribe; aprovechÃ¡ndose della tan a propÃ³sito, que el labrador se iba dando al diablo de oÃ­r tanta mÃ¡quina de necedades; por donde conociÃ³ que su vecino estaba loco, y dÃ¡bale priesa a llegar al pueblo, por escusar el enfado que don Quijote le causaba con su larga arenga. Al cabo de lo cual, dijo:</p><p class="ql-align-justify">	â Sepa vuestra merced, seÃ±or don Rodrigo de NarvÃ¡ez, que esta hermosa Jarifa que he dicho es ahora la linda Dulcinea del Toboso, por quien yo he hecho, hago y harÃ© los mÃ¡s famosos hechos de caballerÃ­as que se han visto, vean ni verÃ¡n en el mundo.</p><p class="ql-align-justify">	A esto respondiÃ³ el labrador:</p><p class="ql-align-justify">	â Mire vuestra merced, seÃ±or, pecador de mÃ­, que yo no soy don Rodrigo de NarvÃ¡ez, ni el marquÃ©s de Mantua, sino Pedro Alonso, su vecino; ni vuestra merced es Valdovinos, ni AbindarrÃ¡ez, sino el honrado hidalgo del seÃ±or Quijana.</p><p class="ql-align-justify">	â Yo sÃ© quiÃ©n soy ârespondiÃ³ don Quijoteâ; y sÃ© que puedo ser no sÃ³lo los que he dicho, sino todos los Doce Pares de Francia, y aun todos los Nueve de la Fama, pues a todas las hazaÃ±as que ellos todos juntos y cada uno por sÃ­ hicieron, se aventajarÃ¡n las mÃ­as.</p><p class="ql-align-justify">	En estas plÃ¡ticas y en otras semejantes, llegaron al lugar a la hora que anochecÃ­a, pero el labrador aguardÃ³ a que fuese algo mÃ¡s noche, porque no viesen al molido hidalgo tan mal caballero. Llegada, pues, la hora que le pareciÃ³, entrÃ³ en el pueblo, y en la casa de don Quijote, la cual hallÃ³ toda alborotada; y estaban en ella el cura y el barbero del lugar, que eran grandes amigos de don Quijote, que estaba diciÃ©ndoles su ama a voces:</p><p class="ql-align-justify">	â Â¿QuÃ© le parece a vuestra merced, seÃ±or licenciado Pero PÃ©rez âque asÃ­ se llamaba el curaâ, de la desgracia de mi seÃ±or? Tres dÃ­as ha que no parecen Ã©l, ni el rocÃ­n, ni la adarga, ni la lanza ni las armas. Â¡Desventurada de mÃ­!, que me doy a entender, y asÃ­ es ello la verdad como nacÃ­ para morir, que estos malditos libros de caballerÃ­as que Ã©l tiene y suele leer tan de ordinario le han vuelto el juicio; que ahora me acuerdo haberle oÃ­do decir muchas veces, hablando entre sÃ­, que querÃ­a hacerse caballero andante e irse a buscar las aventuras por esos mundos. Encomendados sean a SatanÃ¡s y a BarrabÃ¡s tales libros, que asÃ­ han echado a perder el mÃ¡s delicado entendimiento que habÃ­a en toda la Mancha.</p><p class="ql-align-justify">	La sobrina decÃ­a lo mesmo, y aun decÃ­a mÃ¡s:</p><p class="ql-align-justify">	â Sepa, seÃ±or maese NicolÃ¡s âque Ã©ste era el nombre del barberoâ, que muchas veces le aconteciÃ³ a mi seÃ±or tÃ­o estarse leyendo en estos desalmados libros de desventuras dos dÃ­as con sus noches, al cabo de los cuales, arrojaba el libro de las manos, y ponÃ­a mano a la espada y andaba a cuchilladas con las paredes; y cuando estaba muy cansado, decÃ­a que habÃ­a muerto a cuatro gigantes como cuatro torres, y el sudor que sudaba del cansancio decÃ­a que era sangre de las feridas que habÃ­a recebido en la batalla; y bebÃ­ase luego un gran jarro de agua frÃ­a, y quedaba sano y sosegado, diciendo que aquella agua era una preciosÃ­sima bebida que le habÃ­a traÃ­do el sabio Esquife, un grande encantador y amigo suyo. Mas yo me tengo la culpa de todo, que no avisÃ© a vuestras mercedes de los disparates de mi seÃ±or tÃ­o, para que lo remediaran antes de llegar a lo que ha llegado, y quemaran todos estos descomulgados libros, que tiene muchos, que bien merecen ser abrasados, como si fuesen de herejes.</p> --}}
  
      </div>
  </div>
</div>


